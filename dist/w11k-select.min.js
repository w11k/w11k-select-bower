/**
 * w11k-select - v0.8.0 - 2016-09-27
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2016 w11k GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle","w11k.select.template"]),angular.module("w11k.select").constant("w11kSelectConfig",{common:{templateUrl:"w11k-select.tpl.html"},instance:{required:!1,hideCheckboxes:!1,multiple:!0,disabled:!1,header:{placeholder:"",text:void 0},dropdown:{onOpen:void 0,onClose:void 0},filter:{active:!0,placeholder:"Filter",select:{active:!0,text:void 0},deselect:{active:!0,text:void 0}},style:{marginBottom:"10px",maxHeight:void 0},showClearAlways:!1}}),angular.module("w11k.select").factory("w11kSelectHelper",["$parse","$document",function(a,b){function c(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,d){a[d]&&a[d].constructor&&a[d].constructor===Object?c(a[d],b):a[d]=b})}),a}function d(a){var b;b="object"==typeof a?angular.toJson(a):a.toString();for(var c=0,d=b.length,e=0;d>e;e++)c=b.charCodeAt(e)+(c<<6)+(c<<16)-c;return c.toString(36)}function e(b){var c=b.match(g);if(!c){var d='"item.value" [as "item.label"] for "item" in "collection [ | filter ] [track by item.value.unique]"';throw new Error("Expected options in form of '"+d+"' but got \""+b+'".')}var e={value:a(c[1]),label:a(c[2]||c[1]),item:c[3],collection:a(c[4])};return void 0!==c[5]&&(e.tracking=a(c[5])),e}function f(a,c){if(angular.isFunction(a.parents)){var d=a.parents(c);if(d.length>0)return d[0]}else{var e="MatchesSelector",f=["matches","matchesSelector","moz"+e,"webkit"+e,"ms"+e,"o"+e];for(var g in f){var h=f[g];if(angular.isFunction(a[0][h])){for(var i=a[0].parentNode;i!==b[0];){if(i[h](c))return i;i=i.parentNode}return}}}}var g=/^([a-zA-Z][\w\.]*)(?:\s+as\s+([a-zA-Z][\w\.]*))?\s+for\s+(?:([a-zA-Z][\w]*))\s+in\s+([a-zA-Z][\w\.\(\)]*(?:\s+\|\s[a-zA-Z][\w\:_\{\}']*)*)(?:\s+track\sby\s+([a-zA-Z][\w\.]*))?$/;return{parseOptions:e,hashCode:d,extendDeep:c,getParent:f}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","w11kSelectHelper","$filter","$timeout","$window","$q",function(a,b,c,d,e,f,g,h){var i=angular.element(g);return{restrict:"A",replace:!1,templateUrl:a.common.templateUrl,scope:{},require:"ngModel",compile:function(j,k){var l=b(k.w11kSelectConfig),m=d.parseOptions(k.w11kSelectOptions),n=b(k.ngModel).assign,o=m.value.assign;if(void 0!==m.tracking&&void 0===o)throw new Error("value part of w11kSelectOptions expression must be assignable if 'track by' is used");return function(b,j,k,p){function q(){$.then(function(){s(),B()}),S||(r(),S=!0)}function r(){if(b.config.filter.select.active&&b.config.filter.select.text){var a=N.querySelector(".select-filtered-text");a.textContent=b.config.filter.select.text}if(b.config.filter.deselect.active&&b.config.filter.deselect.text){var c=N.querySelector(".deselect-filtered-text");c.textContent=b.config.filter.deselect.text}if(b.config.header.placeholder){var d=N.querySelector(".header-placeholder");d.textContent=b.config.header.placeholder}}function s(){if(b.config.multiple===!1){var a=P.filter(function(a){return a.selected});a.length>0&&(I(a,!1),a[0].selected=!0)}}function t(a){27===a.keyCode&&b.dropdown.close()}function u(){if(angular.isDefined(b.config.style.maxHeight))U.style.maxHeight=b.style.maxHeight;else{var a=w();U.style.maxHeight=a+"px"}}function v(){U.style.maxHeight=""}function w(){var a,c,d,e=U.getBoundingClientRect().top,f=g.innerHeight||g.document.documentElement.clientHeight;if(angular.isDefined(V)?(c=V.innerHeight||V.clientHeight,d=V.getBoundingClientRect().top):(c=g.innerHeight||g.document.documentElement.clientHeight,d=0),b.config.style.marginBottom.indexOf("px")<0)throw new Error("Illegal Value for w11kSelectStyle.marginBottom");var h,i,j=parseFloat(b.config.style.marginBottom.slice(0,-2));c+d>f?(h=f,i=0):(h=c,i=d),a=h-(e-i)-j;var k=93;return k>a&&(a=k),a}function x(){if(angular.isDefined(b.config.header.text))W.textContent=b.$parent.$eval(b.config.header.text);else{var a=P.filter(function(a){return a.selected}),c=a.map(function(a){return a.label});W.textContent=c.join(", ")}}function y(){O&&(R=X(P,b.filter.values,!1),b.options.visible=R.slice(0,Y))}function z(a,b){for(var c={},d=b.length;d--;){var e=D(b[d]);c[e]=!0}var f=a.map(function(a){var b,d=L(a),e=D(d),f=M(a);b=c[e]?!0:!1;var g={trackingId:e,label:f,model:a,selected:b};return g});return f}function A(){var a=J(P);p.$setViewValue(a),x()}function B(){var a=J(P);angular.forEach(p.$parsers,function(b){a=b(a)}),n(b.$parent,a)}function C(){$.then(function(){ab=!0;var a=p.$viewValue;I(P,!1);for(var b=a.length;b--;){var c=D(a[b]),d=Q[c];d&&(d.selected=!0)}x()})}function D(a){if(void 0!==m.tracking){var b={};o(b,a);var c=m.tracking(b);if(void 0===c)throw new Error("Couldn't get 'track by' value. Please make sure to only use something in 'track byâ€™ part of w11kSelectOptions expression, accessible from result of value part. ('option.data' and 'option.data.unique' but not 'option.unique')");return c.toString()}return d.hashCode(a)}function E(a){var b;return b=angular.isArray(a)?a:angular.isDefined(a)?[a]:[]}function F(a){if(!angular.isUndefined(a)){var c;return c=b.config.multiple?a:a[0]}}function G(a){return b.config.multiple===!0&&b.config.required===!0&&0===a.length?!1:b.config.multiple===!1&&b.config.required===!0&&void 0===a?!1:!0}function H(){var a=p.$viewValue;return!(angular.isArray(a)&&a.length>0)}function I(a,b){for(var c=a.length;c--;)a[c].selected=b}function J(a){var b=a.filter(function(a){return a.selected}),c=b.map(K);return c}function K(a){return L(a.model)}function L(a){var b={};return b[m.item]=a,m.value(b)}function M(a){var b={};return b[m.item]=a,m.label(b)}var N=j[0],O=!1,P=[],Q={},R=[];b.options={visible:[]},b.filter={values:{}},b.config=angular.copy(a.instance);var S=!1;b.$watch(function(){return l(b.$parent)},function(a){angular.isArray(a)?(d.extendDeep.apply(null,[b.config].concat(a)),q()):angular.isObject(a)&&(d.extendDeep(b.config,a),q())},!0);var T=N.querySelector(".dropdown-menu"),U=N.querySelector(".dropdown-menu .content"),V=d.getParent(j,".w11k-select-adjust-height-to"),W=N.querySelector(".header-text");b.dropdown={onOpen:function(a){return b.config.disabled?void a.prevent():(O===!1&&(O=!0,y()),c.on("keyup",t),T.style.visibility="hidden",f(function(){u(),T.style.visibility="visible",b.config.filter.active&&f(function(){j[0].querySelector(".dropdown-menu input").focus()})}),i.on("resize",u),void(angular.isFunction(b.config.dropdown.onOpen)&&b.config.dropdown.onOpen()))},onClose:function(){b.filter.values.label="",f(function(){v()}),c.off("keyup",t),i.off("resize",u),angular.isFunction(b.config.dropdown.onClose)&&b.config.dropdown.onClose()}},b.$on("$destroy",function(){c.off("keyup",t),i.off("resize",u)}),b.onKeyPressedOnDropDownToggle=function(a){(13===a.keyCode||32===a.keyCode)&&(a.preventDefault(),a.stopPropagation(),b.dropdown.toggle())};var X=e("filter"),Y=80,Z=.5*Y;b.showMoreOptions=function(){b.options.visible=R.slice(0,b.options.visible.length+Z)},b.onFilterValueChanged=function(){y()},b.clearFilter=function(){b.filter.values={},y()},b.onKeyPressedInFilter=function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation(),b.selectFiltered())},b.selectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),b.config.multiple?I(R,!0):1===R.length&&b.select(R[0]),A()},b.deselectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),I(R,!1),A()},b.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),I(P,!1),A()};var $,_=function(){var a=h.defer();return $=a.promise,function(){var c=m.collection(b.$parent),d=p.$viewValue;if(angular.isArray(c)){P=z(c,d),Q={};for(var e=P.length;e--;){var f=P[e];if(Q[f.trackingId])throw new Error("Duplicate hash value for options "+f.label+" and "+Q[f.trackingId].label);Q[f.trackingId]=f}y(),ab&&B(),a.resolve()}}}();b.$watchCollection(function(){return m.collection(b.$parent)},function(a){angular.isDefined(a)&&_()}),b.select=function(a){a.selected===!1&&b.config.multiple===!1?(I(P,!1),a.selected=!0,b.dropdown.close(),A()):a.selected&&b.config.required===!1&&b.config.multiple===!1?(a.selected=!1,b.dropdown.close(),A()):b.config.multiple&&(a.selected=!a.selected,A())},b.onOptionStateClick=function(a,c){a.stopPropagation(),c.selected&&b.config.required&&b.config.multiple===!1&&a.preventDefault(),b.select(c)};var ab;b.isEmpty=H,p.$isEmpty=H,p.$render=C,p.$formatters.push(E),1===angular.version.major&&angular.version.minor<3?p.$parsers.push(function(a){p.$setValidity("required",G(a))}):p.$validators.required=G,p.$parsers.push(F)}}}}]),angular.module("w11k.select").directive("w11kSelectInfiniteScroll",["$timeout",function(a){return{link:function(b,c,d){var e=0,f=!0,g=!1,h=function(){k(!0)},i=c[0];if(1!==i.children.length)throw new Error("scroll container has to have exactly one child!");var j=i.children[0],k=function(a){var c=j.clientHeight-i.scrollTop,h=c<=i.clientHeight*(e+1);h&&f?a?b.$apply(function(){b.$eval(d.w11kSelectInfiniteScroll)}):b.$eval(d.w11kSelectInfiniteScroll):h&&(g=!0)};return d.$observe("w11kSelectInfiniteScrollDistance",function(a){e=parseFloat(a)}),d.$observe("w11kSelectInfiniteScrollDisabled",function(a){f=!a,f&&g&&(g=!1,k())}),c.on("scroll",h),b.$on("$destroy",function(){c.off("scroll",h)}),a(function(){d.w11kSelectInfiniteScrollImmediateCheck&&b.$eval(d.w11kSelectInfiniteScrollImmediateCheck)&&k()})}}}]);