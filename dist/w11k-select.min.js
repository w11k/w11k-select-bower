/**
 * w11k-select - v0.3.2 - 2014-03-30
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle"]),angular.module("w11k.select").constant("w11kSelectConfig",{templateUrl:"w11k-select.tpl.html"}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(a,b,c,d,e,f,g){var h=angular.element(g);return{restrict:"A",replace:!1,templateUrl:a.templateUrl,scope:{isMultiple:"=?multiple",isRequired:"=?required",isDisabled:"=?disabled"},require:"ngModel",link:function(a,b,i,j){function k(){var a=b[0].querySelector(".dropdown-menu .content"),c=a.getBoundingClientRect(),d=g.innerHeight,e=d-c.top-60,f=93;f>e&&(e=f),a.style.maxHeight=e+"px"}function l(){var a=b[0].querySelector(".dropdown-menu .content");a.style.maxHeight=""}function m(){if(w())return E.placeholder;var a,b=C.filter(function(a){return a.selected}),c=b.map(function(a){return a.label}),d=c.join(", ");if(null!==E.selectedMessage){var e={length:b.length,selectedItems:d};a=E.selectedMessage.replace(/\{(.*)\}/g,function(a,b){return e[b]})}else a=d;return a}function n(){a.header.text=m()}function o(){B&&(D=K(C,a.filter.values,!1),a.optionsToShow=L(D,M))}function p(a,b){return a.map(function(a,c){var d,e=z(a),f=A(a);return d=angular.isArray(b)&&-1!==b.indexOf(e)?!0:!1,{index:c,label:f,model:a,selected:d}})}function q(){var b=Q.collection(a.$parent),c=j.$viewValue;C=p(b,c),o(),r()}function r(){var a=x(C);j.$setViewValue(a),n()}function s(){var a=j.$viewValue;angular.forEach(C,function(b){var c=y(b);b.selected=-1!==a.indexOf(c)?!0:!1}),n()}function t(a){var b;return b=angular.isArray(a)?a:[a]}function u(b){var c;return c=a.isMultiple?b:b[0]}function v(b){if(angular.isUndefined(a.isRequired)||a.isRequired===!1)return b;var c=!1;return a.isMultiple===!0&&angular.isArray(b)&&b.length>0&&(c=!0),j.$setValidity("required",c),c?b:void 0}function w(){var a=j.$viewValue;return!(angular.isArray(a)&&a.length>0)}function x(a){var b=a.filter(function(a){var b=a.selected,c=angular.isArray(a.children)&&a.partlySelected;return b||c}),c=b.map(y);return c}function y(a){return z(a.model)}function z(a){var b={};return b[Q.item]=a,Q.value(b)}function A(a){var b={};return b[Q.item]=a,Q.label(b)}var B=!1,C=[],D=[];a.optionsToShow=[];var E={placeholder:"",selectedMessage:null};a.header={text:""},a.filter={active:!0,values:{},placeholder:""};var F=function(b){27===b.keyCode&&a.dropdown.close()};a.dropdown={onOpen:function(d){return a.isDisabled?void d.prevent():(B===!1&&(B=!0,o()),a.filter.active&&f(function(){b[0].querySelector(".dropdown-menu input").focus()}),c.on("keyup",F),f(function(){k()}),void h.on("resize",k))},onClose:function(){a.filter.values.label="",f(function(){l()}),c.off("keyup",F),h.off("resize",k)}},a.$on("$destroy",function(){c.off("keyup",F),h.off("resize",k)});var G=i.$observe("placeholder",function(b){angular.isDefined(b)&&(E.placeholder=a.$eval(b),n(),angular.isFunction(G)&&(G(),G=void 0))}),H=i.$observe("selectedMessage",function(b){angular.isDefined(b)&&(E.selectedMessage=a.$eval(b),n(),angular.isFunction(H)&&(H(),H=void 0))}),I=i.$observe("selectFilteredText",function(c){if(angular.isDefined(c)){var d=a.$eval(c),e=angular.element(b[0].querySelector(".select-filtered-text"));e.text(d),angular.isFunction(I)&&(I(),I=void 0)}}),J=i.$observe("deselectFilteredText",function(c){if(angular.isDefined(c)){var d=a.$eval(c),e=angular.element(b[0].querySelector(".deselect-filtered-text"));e.text(d),angular.isFunction(J)&&(J(),J=void 0)}}),K=e("filter"),L=e("limitTo"),M=80,N=.5*M;a.showMoreOptions=function(){a.optionsToShow=D.slice(0,a.optionsToShow.length+N)};var O=i.$observe("filterPlaceholder",function(b){angular.isDefined(b)&&(a.filter.placeholder=a.$eval(b),angular.isFunction(O)&&(O(),O=void 0))});a.$watch("filter.values",function(){o()},!0),a.clearFilter=function(){a.filter.values={}},a.onKeyPressedInFilter=function(b){13===b.keyCode&&(b.preventDefault(),b.stopPropagation(),a.selectFiltered())},a.selectFiltered=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),a.isMultiple?angular.forEach(D,function(a){a.selected=!0}):1===D.length&&(D[0].selected=!0),r()},a.deselectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(D,function(a){a.selected=!1}),r()},a.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(C,function(a){a.selected=!1}),r()};var P=i.options,Q=d.parse(P);a.select=function(b){a.isMultiple?b.selected=!b.selected:(a.deselectAll(),b.selected=!0,a.dropdown.close()),r()},a.$watch(function(){return Q.collection(a.$parent)},function(a){angular.isDefined(a)&&q()},!0),a.onOptionStateClick=function(a){a.stopPropagation()},a.onOptionStateChange=function(){r()},a.isEmpty=function(){return w()},j.$render=s,j.$isEmpty=w,j.$parsers.push(v),j.$parsers.push(u),j.$formatters.push(t)}}}]),angular.module("w11k.select").directive("infiniteScroll",["$timeout",function(a){return{link:function(b,c,d){var e=0,f=!0,g=!1,h=function(){k(!0)},i=c[0];if(1!==i.children.length)throw new Error("scroll container has to have exactly one child!");var j=i.children[0],k=function(a){var c=j.clientHeight-i.scrollTop,h=c<=i.clientHeight*(e+1);h&&f?a?b.$apply(function(){b.$eval(d.infiniteScroll)}):b.$eval(d.infiniteScroll):h&&(g=!0)};return d.$observe("infiniteScrollDistance",function(a){e=parseFloat(a)}),d.$observe("infiniteScrollDisabled",function(a){f=!a,f&&g&&(g=!1,k())}),c.on("scroll",h),b.$on("$destroy",function(){c.off("scroll",h)}),a(function(){d.infiniteScrollImmediateCheck&&b.$eval(d.infiniteScrollImmediateCheck)&&k()})}}}]);