/**
 * w11k-select - v0.1.1 - 2014-03-05
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle"]),angular.module("w11k.select").constant("w11kSelectConfig",{templateUrl:"w11k-select.tpl.html"}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(a,b,c,d,e,f,g){return{restrict:"A",replace:!1,templateUrl:a.templateUrl,scope:{isMultiple:"=?multiple",isRequired:"=?required",isDisabled:"=?disabled"},require:"ngModel",link:function(a,b,c,h){function i(){var a=b.find(".dropdown-menu .content"),c=a.offset(),d=$(g).scrollTop(),e=g.innerHeight,f=e-(c.top-d)-60,h=93;h>f&&(f=h),a.css("max-height",f)}function j(){var a=b.find(".dropdown-menu .content");a.css("max-height","")}function k(){if(u())return A.placeholder;var a,b=z.filter(function(a){return a.selected}),c=b.map(function(a){return a.label}),d=c.join(", ");if(null!==A.selectedMessage){var e={length:b.length,selectedItems:d};a=A.selectedMessage.replace(/\{(.*)\}/g,function(a,b){return e[b]})}else a=d;return a}function l(){a.header.text=k()}function m(){a.optionsFiltered=D(z,a.filter.values,!1)}function n(a,b){return a.map(function(a){var c,d=x(a),e=y(a);return c=angular.isArray(b)&&-1!==b.indexOf(d)?!0:!1,{label:e,model:a,selected:c}})}function o(){var b=G.collection(a.$parent),c=h.$viewValue;z=n(b,c),m(),p()}function p(){var a=v(z);h.$setViewValue(a),l()}function q(){var a=h.$viewValue;angular.forEach(z,function(b){var c=w(b);b.selected=-1!==a.indexOf(c)?!0:!1}),l()}function r(a){var b;return b=angular.isArray(a)?a:[a]}function s(b){var c;return c=a.isMultiple?b:b[0]}function t(b){if(angular.isUndefined(a.isRequired)||a.isRequired===!1)return b;var c=!1;return a.isMultiple===!0&&angular.isArray(b)&&b.length>0&&(c=!0),h.$setValidity("required",c),c?b:void 0}function u(){var b=h.$modelValue;return a.isMultiple?!(angular.isArray(b)&&b.length>0):angular.isUndefined(b)}function v(a){var b=a.filter(function(a){var b=a.selected,c=angular.isArray(a.children)&&a.partlySelected;return b||c}),c=b.map(w);return c}function w(a){return x(a.model)}function x(a){var b={};return b[G.item]=a,G.value(b)}function y(a){var b={};return b[G.item]=a,G.label(b)}var z=[];a.optionsFiltered=[];var A={placeholder:"",selectedMessage:null};a.header={text:""},a.filter={active:!0,values:{},placeholder:""},a.dropdown={onOpen:function(c){return a.isDisabled?void c.prevent():void(a.filter.active&&f(function(){b.find(".dropdown-menu input").first().focus(),i(),$(g).on("resize",i)}))},onClose:function(){a.filter.values.label="",f(function(){j()}),$(g).off("resize",i)}};var B=c.$observe("placeholder",function(b){angular.isDefined(b)&&(A.placeholder=a.$eval(b),l(),B(),B=null)}),C=c.$observe("selectedMessage",function(b){angular.isDefined(b)&&(A.selectedMessage=a.$eval(b),l(),C(),C=null)}),D=e("filter"),E=c.$observe("filterPlaceholder",function(b){angular.isDefined(b)&&(a.filter.placeholder=a.$eval(b),E(),E=null)});a.$watch("filter.values",function(){m()},!0),a.clearFilter=function(){a.filter.values={}},a.onKeyPressedInFilter=function(b){13===b.keyCode&&(b.preventDefault(),b.stopPropagation(),a.selectAll())},a.selectAll=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),a.isMultiple!==!1&&(angular.forEach(a.optionsFiltered,function(a){a.selected=!0}),p())},a.deselectAll=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),angular.forEach(a.optionsFiltered,function(a){a.selected=!1}),p()};var F=c.options,G=d.parse(F);a.select=function(b){a.isMultiple?b.selected=!b.selected:(a.deselectAll(),b.selected=!0,a.dropdown.close()),p()},a.$watch(function(){return G.collection(a.$parent)},function(a){angular.isDefined(a)&&o()},!0),a.onOptionStateClick=function(a){a.stopPropagation()},a.onOptionStateChange=function(){p()},a.isEmpty=function(){return u()},h.$render=q,h.$isEmpty=u,h.$parsers.push(t),h.$parsers.push(s),h.$formatters.push(r)}}}]);