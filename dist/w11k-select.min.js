/**
 * w11k-select - v0.4.0 - 2014-06-02
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle"]),angular.module("w11k.select").constant("w11kSelectConfig",{common:{templateUrl:"w11k-select.tpl.html"},instance:{required:!1,multiple:!0,disabled:!1,header:{placeholder:"",text:void 0},filter:{active:!0,placeholder:"Filter",select:{active:!0,text:void 0},deselect:{active:!0,text:void 0}},style:{marginBottom:"10px",maxHeight:void 0}}}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(a,b,c,d,e,f,g){var h=angular.element(g);return{restrict:"A",replace:!1,templateUrl:a.common.templateUrl,scope:{},require:"ngModel",link:function(i,j,k,l){function m(){if(n(),x(),!M){if(i.config.filter.select.active&&i.config.filter.select.text){var a=angular.element(j[0].querySelector(".select-filtered-text"));a.text(i.config.filter.select.text)}if(i.config.filter.deselect.active&&i.config.filter.deselect.text){var b=angular.element(j[0].querySelector(".deselect-filtered-text"));b.text(i.config.filter.deselect.text)}if(i.config.header.placeholder){var c=angular.element(j[0].querySelector(".header-placeholder"));c.text(i.config.header.placeholder)}M=!0}}function n(){var a=K.filter(function(a){return a.selected});i.config.multiple===!1&&a.length>0&&(i.deselectAll(),a[0].selected=!0)}function o(a,b){if(angular.isFunction(a.parents)){var d=a.parents(b);if(d.length>0)return d[0]}else{var e="MatchesSelector",f=["matches","matchesSelector","moz"+e,"webkit"+e,"ms"+e,"o + matchesSelector"];for(var g in f){var h=f[g];if(angular.isFunction(a[0][h])){for(var i=a[0].parentNode;i!==c;){if(i[h](b))return i;i=i.parentNode}return}}}}function p(a){27===a.keyCode&&i.dropdown.close()}function q(){if(angular.isDefined(i.config.style.maxHeight))P.style.maxHeight=i.style.maxHeight;else{var a=s();P.style.maxHeight=a+"px"}}function r(){P.style.maxHeight=""}function s(){var a,b,c,d=P.getBoundingClientRect().top,e=g.innerHeight||g.document.documentElement.clientHeight;if(angular.isDefined(Q)?(b=Q.innerHeight||Q.clientHeight,c=Q.getBoundingClientRect().top):(b=g.innerHeight||g.document.documentElement.clientHeight,c=0),i.config.style.marginBottom.indexOf("px")<0)throw new Error("Illegal Value for w11kSelectStyle.marginBottom");var f,h,j=parseFloat(i.config.style.marginBottom.slice(0,-2));b+c>e?(f=e,h=0):(f=b,h=c),a=f-(d-h)-j;var k=93;return k>a&&(a=k),a}function t(){if(angular.isDefined(i.config.header.text))i.header.text=i.$parent.$eval(i.config.header.text);else{var a=K.filter(function(a){return a.selected}),b=a.map(function(a){return a.label});R.text(b.join(", "))}}function u(){J&&(L=S(K,i.filter.values,!1),i.options.visible=L.slice(0,T))}function v(a,b){return a.map(function(a){var c,d=G(a),e=H(a);return c=angular.isArray(b)&&-1!==b.indexOf(d)?!0:!1,{hash:X(a).toString(36),label:e,model:a,selected:c}})}function w(){var a=W.collection(i.$parent),b=l.$viewValue;K=v(a,b),u(),y()}function x(){var a=E(K);l.$setViewValue(a),t()}function y(){var a=E(K);angular.forEach(l.$parsers,function(b){a=b(a)}),b(k.ngModel).assign(i.$parent,a)}function z(){var a=l.$viewValue;angular.forEach(K,function(b){var c=F(b);b.selected=-1!==a.indexOf(c)?!0:!1}),C(a),t()}function A(a){var b;return b=angular.isArray(a)?a:angular.isDefined(a)?[a]:[],C(b),b}function B(a){if(!angular.isUndefined(a)){var b;return b=i.config.multiple?a:a[0]}}function C(a){var b=!1;return i.config.required===!0&&a.length>0?b=!0:i.config.required===!1&&(b=!0),l.$setValidity("required",b),b?a:void 0}function D(){var a=l.$viewValue;return!(angular.isArray(a)&&a.length>0)}function E(a){var b=a.filter(function(a){return a.selected}),c=b.map(F);return c}function F(a){return G(a.model)}function G(a){var b={};return b[W.item]=a,W.value(b)}function H(a){var b={};return b[W.item]=a,W.label(b)}function I(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,c){a[c]&&a[c].constructor&&a[c].constructor===Object?I(a[c],b):a[c]=b})}),a}var J=!1,K=[],L=[];i.options={visible:[]},i.filter={values:{}},i.config=angular.copy(a.instance);var M=!1;i.$watch(function(){return i.$parent.$eval(k.w11kSelectConfig)},function(a){angular.isArray(a)?(I.apply(null,[i.config].concat(a)),m()):angular.isObject(a)&&(I(i.config,a),m())},!0);var N="visibility",O=angular.element(j[0].querySelector(".dropdown-menu")),P=j[0].querySelector(".dropdown-menu .content"),Q=o(j,".w11k-select-adjust-height-to"),R=angular.element(j[0].querySelector(".header-text"));i.dropdown={onOpen:function(a){return i.config.disabled?void a.prevent():(J===!1&&(J=!0,u()),c.on("keyup",p),O.css(N,"hidden"),f(function(){q(),O.css(N,"visible"),i.config.filter.active&&f(function(){j[0].querySelector(".dropdown-menu input").focus()})}),void h.on("resize",q))},onClose:function(){i.filter.values.label="",f(function(){r()}),c.off("keyup",p),h.off("resize",q)}},i.$on("$destroy",function(){c.off("keyup",p),h.off("resize",q)});var S=e("filter"),T=80,U=.5*T;i.showMoreOptions=function(){i.options.visible=L.slice(0,i.options.visible.length+U)},i.$watch("filter.values.label",function(){u()}),i.clearFilter=function(){i.filter.values={}},i.onKeyPressedInFilter=function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation(),i.selectFiltered())},i.selectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),i.config.multiple?angular.forEach(L,function(a){a.selected=!0}):1===L.length&&(L[0].selected=!0),x()},i.deselectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(L,function(a){a.selected=!1}),x()},i.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(K,function(a){a.selected=!1}),x()};var V=k.w11kSelectOptions,W=d.parse(V);i.select=function(a){i.config.multiple?a.selected=!a.selected:(i.deselectAll(),a.selected=!0,i.dropdown.close()),x()},i.$watch(function(){return W.collection(i.$parent)},function(a){angular.isDefined(a)&&w()}),i.onOptionStateClick=function(a){a.stopPropagation()},i.onOptionStateChange=function(){x()},i.isEmpty=D,l.$isEmpty=D,l.$render=z,l.$formatters.push(A),l.$parsers.push(C),l.$parsers.push(B);var X=function(){var a=function(a){for(var b=0,c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c)|0;return b},b=function(b){var c=b.toString();return a(c)},c=function(a){var c=0;for(var e in a)a.hasOwnProperty(e)&&(c+=b(e+d(a[e])));return c},d=function(d){var e={string:a,number:b,"boolean":b,object:c},f=typeof d;return null===d||void 0===d?0:void 0!==e[f]?e[f](d)+b(f):0};return d}()}}}]),angular.module("w11k.select").directive("infiniteScroll",["$timeout",function(a){return{link:function(b,c,d){var e=0,f=!0,g=!1,h=function(){k(!0)},i=c[0];if(1!==i.children.length)throw new Error("scroll container has to have exactly one child!");var j=i.children[0],k=function(a){var c=j.clientHeight-i.scrollTop,h=c<=i.clientHeight*(e+1);h&&f?a?b.$apply(function(){b.$eval(d.infiniteScroll)}):b.$eval(d.infiniteScroll):h&&(g=!0)};return d.$observe("infiniteScrollDistance",function(a){e=parseFloat(a)}),d.$observe("infiniteScrollDisabled",function(a){f=!a,f&&g&&(g=!1,k())}),c.on("scroll",h),b.$on("$destroy",function(){c.off("scroll",h)}),a(function(){d.infiniteScrollImmediateCheck&&b.$eval(d.infiniteScrollImmediateCheck)&&k()})}}}]);