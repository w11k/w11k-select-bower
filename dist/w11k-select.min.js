/**
 * w11k-select - v0.6.0 - 2014-11-11
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle","w11k.select.template"]),angular.module("w11k.select").constant("w11kSelectConfig",{common:{templateUrl:"w11k-select.tpl.html"},instance:{required:!1,multiple:!0,disabled:!1,header:{placeholder:"",text:void 0},filter:{active:!0,placeholder:"Filter",select:{active:!0,text:void 0},deselect:{active:!0,text:void 0}},style:{marginBottom:"10px",maxHeight:void 0}}}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window","$q",function(a,b,c,d,e,f,g,h){var i=angular.element(g);return{restrict:"A",replace:!1,templateUrl:a.common.templateUrl,scope:{},require:"ngModel",link:function(j,k,l,m){function n(){if(o(),X.then(function(){x()}),!O){if(j.config.filter.select.active&&j.config.filter.select.text){var a=angular.element(k[0].querySelector(".select-filtered-text"));a.text(j.config.filter.select.text)}if(j.config.filter.deselect.active&&j.config.filter.deselect.text){var b=angular.element(k[0].querySelector(".deselect-filtered-text"));b.text(j.config.filter.deselect.text)}if(j.config.header.placeholder){var c=angular.element(k[0].querySelector(".header-placeholder"));c.text(j.config.header.placeholder)}O=!0}}function o(){if(j.config.multiple===!1){var a=L.filter(function(a){return a.selected});a.length>0&&(E(a,!1),a[0].selected=!0)}}function p(a,b){if(angular.isFunction(a.parents)){var d=a.parents(b);if(d.length>0)return d[0]}else{var e="MatchesSelector",f=["matches","matchesSelector","moz"+e,"webkit"+e,"ms"+e,"o"+e];for(var g in f){var h=f[g];if(angular.isFunction(a[0][h])){for(var i=a[0].parentNode;i!==c[0];){if(i[h](b))return i;i=i.parentNode}return}}}}function q(a){27===a.keyCode&&j.dropdown.close()}function r(){if(angular.isDefined(j.config.style.maxHeight))R.style.maxHeight=j.style.maxHeight;else{var a=t();R.style.maxHeight=a+"px"}}function s(){R.style.maxHeight=""}function t(){var a,b,c,d=R.getBoundingClientRect().top,e=g.innerHeight||g.document.documentElement.clientHeight;if(angular.isDefined(S)?(b=S.innerHeight||S.clientHeight,c=S.getBoundingClientRect().top):(b=g.innerHeight||g.document.documentElement.clientHeight,c=0),j.config.style.marginBottom.indexOf("px")<0)throw new Error("Illegal Value for w11kSelectStyle.marginBottom");var f,h,i=parseFloat(j.config.style.marginBottom.slice(0,-2));b+c>e?(f=e,h=0):(f=b,h=c),a=f-(d-h)-i;var k=93;return k>a&&(a=k),a}function u(){if(angular.isDefined(j.config.header.text))T.text(j.$parent.$eval(j.config.header.text));else{var a=L.filter(function(a){return a.selected}),b=a.map(function(a){return a.label});T.text(b.join(", "))}}function v(){K&&(N=U(L,j.filter.values,!1),j.options.visible=N.slice(0,V))}function w(a,b){for(var c={},d=b.length;d--;){var e=bb(b[d]);c[e]=!0}var f=a.map(function(a){var b,d=H(a),e=bb(d),f=I(a);return b=c[e]?!0:!1,{hash:e.toString(36),label:f,model:a,selected:b}});return f}function x(){var a=F(L);m.$setViewValue(a),u()}function y(){var a=F(L);angular.forEach(m.$parsers,function(b){a=b(a)}),ab(j.$parent,a)}function z(){X.then(function(){_=!0;var a=m.$viewValue;E(L,!1);for(var b=a.length;b--;){var c=bb(a[b]).toString(36),d=M[c];d&&(d.selected=!0)}C(a),u()})}function A(a){var b;return b=angular.isArray(a)?a:angular.isDefined(a)?[a]:[],C(b),b}function B(a){if(!angular.isUndefined(a)){var b;return b=j.config.multiple?a:a[0]}}function C(a){var b=!1;return j.config.required===!0&&a.length>0?b=!0:j.config.required===!1&&(b=!0),m.$setValidity("required",b),b?a:void 0}function D(){var a=m.$viewValue;return!(angular.isArray(a)&&a.length>0)}function E(a,b){for(var c=a.length;c--;)a[c].selected=b}function F(a){var b=a.filter(function(a){return a.selected}),c=b.map(G);return c}function G(a){return H(a.model)}function H(a){var b={};return b[Z.item]=a,Z.value(b)}function I(a){var b={};return b[Z.item]=a,Z.label(b)}function J(a){return angular.forEach(arguments,function(b){b!==a&&angular.forEach(b,function(b,c){a[c]&&a[c].constructor&&a[c].constructor===Object?J(a[c],b):a[c]=b})}),a}var K=!1,L=[],M={},N=[];j.options={visible:[]},j.filter={values:{}},j.config=angular.copy(a.instance);var O=!1;j.$watch(function(){return j.$parent.$eval(l.w11kSelectConfig)},function(a){angular.isArray(a)?(J.apply(null,[j.config].concat(a)),n()):angular.isObject(a)&&(J(j.config,a),n())},!0);var P="visibility",Q=angular.element(k[0].querySelector(".dropdown-menu")),R=k[0].querySelector(".dropdown-menu .content"),S=p(k,".w11k-select-adjust-height-to"),T=angular.element(k[0].querySelector(".header-text"));j.dropdown={onOpen:function(a){return j.config.disabled?void a.prevent():(K===!1&&(K=!0,v()),c.on("keyup",q),Q.css(P,"hidden"),f(function(){r(),Q.css(P,"visible"),j.config.filter.active&&f(function(){k[0].querySelector(".dropdown-menu input").focus()})}),void i.on("resize",r))},onClose:function(){j.filter.values.label="",f(function(){s()}),c.off("keyup",q),i.off("resize",r)}},j.$on("$destroy",function(){c.off("keyup",q),i.off("resize",r)});var U=e("filter"),V=80,W=.5*V;j.showMoreOptions=function(){j.options.visible=N.slice(0,j.options.visible.length+W)},j.$watch("filter.values.label",function(){v()}),j.clearFilter=function(){j.filter.values={}},j.onKeyPressedInFilter=function(a){13===a.keyCode&&(a.preventDefault(),a.stopPropagation(),j.selectFiltered())},j.selectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),j.config.multiple?E(N,!0):1===N.length&&j.select(N[0]),x()},j.deselectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),E(N,!1),x()},j.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),E(L,!1),x()};var X,Y=l.w11kSelectOptions,Z=d.parse(Y),$=function(){var a=h.defer();return X=a.promise,function(){var b=Z.collection(j.$parent),c=m.$viewValue;if(angular.isArray(b)){L=w(b,c),M={};for(var d=L.length;d--;){var e=L[d];M[e.hash]=e}v(),_&&y(),a.resolve()}}}();j.$watchCollection(function(){return Z.collection(j.$parent)},function(a){angular.isDefined(a)&&$()}),j.select=function(a){a.selected===!1&&j.config.multiple===!1?(E(L,!1),a.selected=!0,j.dropdown.close(),x()):a.selected&&j.config.required===!1&&j.config.multiple===!1?(a.selected=!1,j.dropdown.close(),x()):j.config.multiple&&(a.selected=!a.selected,x())},j.onOptionStateClick=function(a,b){a.stopPropagation(),b.selected&&j.config.required&&j.config.multiple===!1&&a.preventDefault(),j.select(b)};var _,ab=b(l.ngModel).assign;j.isEmpty=D,m.$isEmpty=D,m.$render=z,m.$formatters.push(A),m.$parsers.push(C),m.$parsers.push(B);var bb=function(){var a=function(a){for(var b=0,c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c)|0;return b},b=function(b){var c=b.toString();return a(c)},c=function(a){var c=0;for(var e in a)a.hasOwnProperty(e)&&(c+=b(e+d(a[e])));return c},d=function(d){var e={string:a,number:b,"boolean":b,object:c},f=typeof d;return null===d||void 0===d?0:void 0!==e[f]?e[f](d)+b(f):0};return d}()}}}]),angular.module("w11k.select").directive("infiniteScroll",["$timeout",function(a){return{link:function(b,c,d){var e=0,f=!0,g=!1,h=function(){k(!0)},i=c[0];if(1!==i.children.length)throw new Error("scroll container has to have exactly one child!");var j=i.children[0],k=function(a){var c=j.clientHeight-i.scrollTop,h=c<=i.clientHeight*(e+1);h&&f?a?b.$apply(function(){b.$eval(d.infiniteScroll)}):b.$eval(d.infiniteScroll):h&&(g=!0)};return d.$observe("infiniteScrollDistance",function(a){e=parseFloat(a)}),d.$observe("infiniteScrollDisabled",function(a){f=!a,f&&g&&(g=!1,k())}),c.on("scroll",h),b.$on("$destroy",function(){c.off("scroll",h)}),a(function(){d.infiniteScrollImmediateCheck&&b.$eval(d.infiniteScrollImmediateCheck)&&k()})}}}]);