/**
 * w11k-select - v0.3.4 - 2014-04-09
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle"]),angular.module("w11k.select").constant("w11kSelectConfig",{templateUrl:"w11k-select.tpl.html"}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(a,b,c,d,e,f,g){var h=angular.element(g);return{restrict:"A",replace:!1,templateUrl:a.templateUrl,scope:{isMultiple:"=?multiple",isRequired:"=?required",isDisabled:"=?disabled"},require:"ngModel",link:function(a,i,j,k){function l(){var a=i[0].querySelector(".dropdown-menu .content"),b=a.getBoundingClientRect(),c=g.innerHeight||g.document.documentElement.clientHeight,d=c-b.top-60,e=93;e>d&&(d=e),a.style.maxHeight=d+"px"}function m(){var a=i[0].querySelector(".dropdown-menu .content");a.style.maxHeight=""}function n(){if(y())return G.placeholder;var a,b=E.filter(function(a){return a.selected}),c=b.map(function(a){return a.label}),d=c.join(", ");if(null!==G.selectedMessage){var e={length:b.length,selectedItems:d};a=G.selectedMessage.replace(/\{(.*)\}/g,function(a,b){return e[b]})}else a=d;return a}function o(){a.header.text=n()}function p(){D&&(F=M(E,a.filter.values,!1),a.optionsToShow=N(F,O))}function q(a,b){return a.map(function(a){var c,d=B(a),e=C(a);return c=angular.isArray(b)&&-1!==b.indexOf(d)?!0:!1,{hash:T(a).toString(36),label:e,model:a,selected:c}})}function r(){var b=S.collection(a.$parent),c=k.$viewValue;E=q(b,c),p(),t()}function s(){var a=z(E);k.$setViewValue(a),o()}function t(){var c=z(E);angular.forEach(k.$parsers,function(a){c=a(c)}),b(j.ngModel).assign(a.$parent,c)}function u(){var a=k.$viewValue;angular.forEach(E,function(b){var c=A(b);b.selected=-1!==a.indexOf(c)?!0:!1}),o()}function v(a){var b;return b=angular.isArray(a)?a:[a]}function w(b){var c;return c=a.isMultiple?b:b[0]}function x(b){if(angular.isUndefined(a.isRequired)||a.isRequired===!1)return b;var c=!1;return a.isMultiple===!0&&angular.isArray(b)&&b.length>0&&(c=!0),k.$setValidity("required",c),c?b:void 0}function y(){var a=k.$viewValue;return!(angular.isArray(a)&&a.length>0)}function z(a){var b=a.filter(function(a){var b=a.selected,c=angular.isArray(a.children)&&a.partlySelected;return b||c}),c=b.map(A);return c}function A(a){return B(a.model)}function B(a){var b={};return b[S.item]=a,S.value(b)}function C(a){var b={};return b[S.item]=a,S.label(b)}var D=!1,E=[],F=[];a.optionsToShow=[];var G={placeholder:"",selectedMessage:null};a.header={text:""},a.filter={active:!0,values:{},placeholder:""};var H=function(b){27===b.keyCode&&a.dropdown.close()};a.dropdown={onOpen:function(b){return a.isDisabled?void b.prevent():(D===!1&&(D=!0,p()),a.filter.active&&f(function(){i[0].querySelector(".dropdown-menu input").focus()}),c.on("keyup",H),f(function(){l()}),void h.on("resize",l))},onClose:function(){a.filter.values.label="",f(function(){m()}),c.off("keyup",H),h.off("resize",l)}},a.$on("$destroy",function(){c.off("keyup",H),h.off("resize",l)});var I=j.$observe("placeholder",function(b){angular.isDefined(b)&&(G.placeholder=a.$eval(b),o(),angular.isFunction(I)&&(I(),I=void 0))}),J=j.$observe("selectedMessage",function(b){angular.isDefined(b)&&(G.selectedMessage=a.$eval(b),o(),angular.isFunction(J)&&(J(),J=void 0))}),K=j.$observe("selectFilteredText",function(b){if(angular.isDefined(b)){var c=a.$eval(b),d=angular.element(i[0].querySelector(".select-filtered-text"));d.text(c),angular.isFunction(K)&&(K(),K=void 0)}}),L=j.$observe("deselectFilteredText",function(b){if(angular.isDefined(b)){var c=a.$eval(b),d=angular.element(i[0].querySelector(".deselect-filtered-text"));d.text(c),angular.isFunction(L)&&(L(),L=void 0)}}),M=e("filter"),N=e("limitTo"),O=80,P=.5*O;a.showMoreOptions=function(){a.optionsToShow=F.slice(0,a.optionsToShow.length+P)};var Q=j.$observe("filterPlaceholder",function(b){angular.isDefined(b)&&(a.filter.placeholder=a.$eval(b),angular.isFunction(Q)&&(Q(),Q=void 0))});a.$watch("filter.values.label",function(){p()}),a.clearFilter=function(){a.filter.values={}},a.onKeyPressedInFilter=function(b){13===b.keyCode&&(b.preventDefault(),b.stopPropagation(),a.selectFiltered())},a.selectFiltered=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),a.isMultiple?angular.forEach(F,function(a){a.selected=!0}):1===F.length&&(F[0].selected=!0),s()},a.deselectFiltered=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(F,function(a){a.selected=!1}),s()},a.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(E,function(a){a.selected=!1}),s()};var R=j.options,S=d.parse(R);a.select=function(b){a.isMultiple?b.selected=!b.selected:(a.deselectAll(),b.selected=!0,a.dropdown.close()),s()},a.$watch(function(){return S.collection(a.$parent)},function(a){angular.isDefined(a)&&r()}),a.onOptionStateClick=function(a){a.stopPropagation()},a.onOptionStateChange=function(){s()},a.isEmpty=function(){return y()},k.$render=u,k.$isEmpty=y,k.$parsers.push(x),k.$parsers.push(w),k.$formatters.push(v);var T=function(){var a=function(a){for(var b=0,c=0;c<a.length;c++)b=(b<<5)-b+a.charCodeAt(c)|0;return b},b=function(b){var c=b.toString();return a(c)},c=function(a){var c=0;for(var e in a)a.hasOwnProperty(e)&&(c+=b(e+d(a[e])));return c},d=function(d){var e={string:a,number:b,"boolean":b,object:c},f=typeof d;return null===d||void 0===d?0:void 0!==e[f]?e[f](d)+b(f):0};return d}()}}}]),angular.module("w11k.select").directive("infiniteScroll",["$timeout",function(a){return{link:function(b,c,d){var e=0,f=!0,g=!1,h=function(){k(!0)},i=c[0];if(1!==i.children.length)throw new Error("scroll container has to have exactly one child!");var j=i.children[0],k=function(a){var c=j.clientHeight-i.scrollTop,h=c<=i.clientHeight*(e+1);h&&f?a?b.$apply(function(){b.$eval(d.infiniteScroll)}):b.$eval(d.infiniteScroll):h&&(g=!0)};return d.$observe("infiniteScrollDistance",function(a){e=parseFloat(a)}),d.$observe("infiniteScrollDisabled",function(a){f=!a,f&&g&&(g=!1,k())}),c.on("scroll",h),b.$on("$destroy",function(){c.off("scroll",h)}),a(function(){d.infiniteScrollImmediateCheck&&b.$eval(d.infiniteScrollImmediateCheck)&&k()})}}}]);