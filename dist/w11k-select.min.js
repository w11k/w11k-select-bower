/**
 * w11k-select - v0.2.0 - 2014-03-28
 * https://github.com/w11k/w11k-select
 *
 * Copyright (c) 2014 WeigleWilczek GmbH
 */
"use strict";angular.module("w11k.select",["pasvaz.bindonce","w11k.dropdownToggle"]),angular.module("w11k.select").constant("w11kSelectConfig",{templateUrl:"w11k-select.tpl.html"}),angular.module("w11k.select").factory("optionParser",["$parse",function(a){var b=/^\s*(.*?)(?:\s+as\s+(.*?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+(.*)$/;return{parse:function(c){var d=c.match(b);if(!d){var e='"value" [as "label"] for "item" in "collection"';throw new Error("Expected options in form of '"+e+"' but got \""+c+'".')}var f={value:a(d[1]),label:a(d[2]||d[1]),item:d[3],collection:a(d[4])};return f}}}]),angular.module("w11k.select").directive("w11kSelect",["w11kSelectConfig","$parse","$document","optionParser","$filter","$timeout","$window",function(a,b,c,d,e,f,g){var h=angular.element;return{restrict:"A",replace:!1,templateUrl:a.templateUrl,scope:{isMultiple:"=?multiple",isRequired:"=?required",isDisabled:"=?disabled"},require:"ngModel",link:function(a,b,c,i){function j(){var a=b[0].querySelector(".dropdown-menu .content"),c=a.getBoundingClientRect(),d=g.innerHeight,e=d-c.top-60,f=93;f>e&&(e=f),a.style.maxHeight=e+"px"}function k(){var a=b[0].querySelector(".dropdown-menu .content");a.style.maxHeight=""}function l(){if(v())return C.placeholder;var a,b=B.filter(function(a){return a.selected}),c=b.map(function(a){return a.label}),d=c.join(", ");if(null!==C.selectedMessage){var e={length:b.length,selectedItems:d};a=C.selectedMessage.replace(/\{(.*)\}/g,function(a,b){return e[b]})}else a=d;return a}function m(){a.header.text=l()}function n(){A&&(a.optionsFiltered=F(B,a.filter.values,!1))}function o(a,b){return a.map(function(a){var c,d=y(a),e=z(a);return c=angular.isArray(b)&&-1!==b.indexOf(d)?!0:!1,{label:e,model:a,selected:c}})}function p(){var b=I.collection(a.$parent),c=i.$viewValue;B=o(b,c),n(),q()}function q(){var a=w(B);i.$setViewValue(a),m()}function r(){var a=i.$viewValue;angular.forEach(B,function(b){var c=x(b);b.selected=-1!==a.indexOf(c)?!0:!1}),m()}function s(a){var b;return b=angular.isArray(a)?a:[a]}function t(b){var c;return c=a.isMultiple?b:b[0]}function u(b){if(angular.isUndefined(a.isRequired)||a.isRequired===!1)return b;var c=!1;return a.isMultiple===!0&&angular.isArray(b)&&b.length>0&&(c=!0),i.$setValidity("required",c),c?b:void 0}function v(){var a=i.$viewValue;return!(angular.isArray(a)&&a.length>0)}function w(a){var b=a.filter(function(a){var b=a.selected,c=angular.isArray(a.children)&&a.partlySelected;return b||c}),c=b.map(x);return c}function x(a){return y(a.model)}function y(a){var b={};return b[I.item]=a,I.value(b)}function z(a){var b={};return b[I.item]=a,I.label(b)}var A=!1,B=[];a.optionsFiltered=[];var C={placeholder:"",selectedMessage:null};a.header={text:""},a.filter={active:!0,values:{},placeholder:""},a.dropdown={onOpen:function(c){return a.isDisabled?void c.prevent():(A===!1&&(A=!0,n()),a.filter.active&&f(function(){b[0].querySelector(".dropdown-menu input").focus()}),f(function(){j()}),void h(g).on("resize",j))},onClose:function(){a.filter.values.label="",f(function(){k()}),h(g).off("resize",j)}};var D=c.$observe("placeholder",function(b){angular.isDefined(b)&&(C.placeholder=a.$eval(b),m(),D(),D=null)}),E=c.$observe("selectedMessage",function(b){angular.isDefined(b)&&(C.selectedMessage=a.$eval(b),m(),E(),E=null)}),F=e("filter"),G=c.$observe("filterPlaceholder",function(b){angular.isDefined(b)&&(a.filter.placeholder=a.$eval(b),G(),G=null)});a.$watch("filter.values",function(){n()},!0),a.clearFilter=function(){a.filter.values={}},a.onKeyPressedInFilter=function(b){13===b.keyCode&&(b.preventDefault(),b.stopPropagation(),a.selectAll())},a.selectFiltered=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),a.isMultiple?angular.forEach(a.optionsFiltered,function(a){a.selected=!0}):1===a.optionsFiltered.length&&(a.optionsFiltered[0].selected=!0),q()},a.deselectFiltered=function(b){angular.isDefined(b)&&(b.preventDefault(),b.stopPropagation()),angular.forEach(a.optionsFiltered,function(a){a.selected=!1}),q()},a.deselectAll=function(a){angular.isDefined(a)&&(a.preventDefault(),a.stopPropagation()),angular.forEach(B,function(a){a.selected=!1}),q()};var H=c.options,I=d.parse(H);a.select=function(b){a.isMultiple?b.selected=!b.selected:(a.deselectAll(),b.selected=!0,a.dropdown.close()),q()},a.$watch(function(){return I.collection(a.$parent)},function(a){angular.isDefined(a)&&p()},!0),a.onOptionStateClick=function(a){a.stopPropagation()},a.onOptionStateChange=function(){q()},a.isEmpty=function(){return v()},i.$render=r,i.$isEmpty=v,i.$parsers.push(u),i.$parsers.push(t),i.$formatters.push(s)}}}]);